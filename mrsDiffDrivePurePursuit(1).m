%% EXAMPLE: Differential drive vehicle following waypoints using the 
% Pure Pursuit algorithm
%
% Copyright 2018-2019 The MathWorks, Inc.

%% Define Vehicle
R = 0.1;                % Wheel radius [m]
L = 0.5;                % Wheelbase [m]
dd = DifferentialDrive(R,L);

%% Simulation parameters
sampleTime = 0.1;               % Sample time [s]
tVec = 0:sampleTime:220;         % Time array

initPose = [1.8777777777778; 2.4333333333333;90];             % Initial pose (x y theta)



pose = zeros(3,numel(tVec));    % Pose matrix
pose(:,1) = initPose;

% Define waypoints

waypoints = [1.8777777777778, 2.4333333333333; 1.7666666666667, 2.6777777777778; 1.6555555555556, 2.9888888888889; 1.6444444444444, 3.6555555555556; 1.4111111111111, 4.1444444444444; 1.1777777777778, 3.9666666666667; 1.0777777777778, 3.5111111111111; 1.2111111111111, 3.1; 1.1888888888889, 2.7222222222222; 1.4, 2.3333333333333; 1.8222222222222, 2.2111111111111; 1.9111111111111, 1.8222222222222; 2.0111111111111, 1.3777777777778; 2.2444444444444, 1; 2.4666666666667, 0.6; 2.8222222222222, 0.2666666666667; 3.1888888888889, -0.0555555555556; 3.6444444444444, -0.2888888888889; 4.2888888888889, -0.4111111111111; 4.7444444444444, -0.3444444444444; 5.2444444444444, -0.0222222222222; 5.7111111111111, 0.4333333333333; 6.0777777777778, 0.8444444444444; 6.3333333333333, 1.3444444444444; 6.4222222222222, 1.7555555555556; 6.5666666666667, 2.2666666666667; 6.7555555555556, 2.8222222222222; 6.8444444444444, 3.2666666666667; 6.7555555555556, 3.9; 7.0888888888889, 4.3555555555556; 7.3555555555556, 4.1555555555556; 7.4222222222222, 3.8111111111111; 7.2111111111111, 3.3888888888889; 7.2, 3.0666666666667; 7.0555555555556, 2.6333333333333; 6.8888888888889, 2.3222222222222; 6.6333333333333, 2.3555555555556; 6.8444444444444, 3.3666666666667; 6.8111111111111, 4.1222222222222; 6.6777777777778, 4.6; 6.6, 4.2888888888889; 6.4888888888889, 3.8888888888889; 6.2111111111111, 3.5333333333333; 5.6555555555556, 3.3333333333333; 5.0777777777778, 3.5666666666667; 4.7444444444444, 3.9111111111111; 4.6444444444444, 4.1444444444444; 5.0333333333333, 4.1888888888889; 5.4555555555556, 4.0888888888889; 5.8777777777778, 4.1444444444444; 6.1444444444444, 4.2777777777778; 5.8888888888889, 4.5222222222222; 5.5888888888889, 4.5666666666667; 5.2444444444444, 4.4888888888889; 4.9888888888889, 4.3333333333333; 4.5555555555556, 4.7222222222222; 4.5111111111111, 4.4555555555556; 4.4777777777778, 4.0777777777778; 4.5666666666667, 3.6777777777778; 4.6888888888889, 3.4333333333333; 4.8666666666667, 3.2222222222222; 5, 3; 5, 2.8222222222222; 4.8888888888889, 2.6555555555556; 4.6888888888889, 2.7222222222222; 4.8444444444444, 2.8111111111111; 4.7333333333333, 2.9333333333333; 4.5, 2.8777777777778; 4.4, 2.7; 4.5555555555556, 2.0777777777778; 4.7666666666667, 1.9777777777778; 5, 1.8222222222222; 5.2111111111111, 1.6222222222222; 5.2111111111111, 1.4111111111111; 4.9777777777778, 1.2666666666667; 4.7777777777778, 1.1222222222222; 4.4444444444444, 0.9888888888889; 4.2111111111111, 0.9111111111111; 4, 1; 3.7666666666667, 1.1777777777778; 3.5, 1.3111111111111; 3.2666666666667, 1.4888888888889; 3.4222222222222, 1.7444444444444; 3.7, 1.9111111111111; 4, 2; 4.2111111111111, 1.8777777777778; 4.4, 1.9888888888889; 4.0888888888889, 2.7; 3.9777777777778, 2.8666666666667; 3.7555555555556, 2.9; 3.7, 2.6555555555556; 3.5555555555556, 2.7666666666667; 3.4222222222222, 2.9888888888889; 3.6111111111111, 3.2111111111111; 3.7888888888889, 3.4333333333333; 3.9111111111111, 3.6666666666667; 4, 4; 3.9777777777778, 4.3; 3.9111111111111, 4.6888888888889; 3.5222222222222, 4.1; 3.2555555555556, 4.2666666666667; 3.0555555555556, 4.4; 2.7888888888889, 4.4; 2.5666666666667, 4.3111111111111; 2.3333333333333, 4.1222222222222; 2.6555555555556, 4.0444444444444; 3, 4; 3.3888888888889, 4.0555555555556; 3.9333333333333, 4.1666666666667; 3.8, 3.9; 3.6333333333333, 3.6777777777778; 3.3888888888889, 3.4222222222222; 3.0888888888889, 3.2222222222222; 2.4777777777778, 3.2; 2.2222222222222, 3.4; 2, 4; 1.9222222222222, 4.3444444444444; 2.1666666666667, 4.7444444444444; 2.6333333333333, 4.9222222222222; 3, 5; 3.4888888888889, 5.0333333333333; 3.8666666666667, 5.0333333333333; 4.3, 5.0555555555556; 4.7222222222222, 5.0666666666667; 5.1444444444444, 5.0888888888889; 5.6, 5.1111111111111; 6, 5; 6.3777777777778, 4.9222222222222; 6.6111111111111, 4.6666666666667; 6.5333333333333, 5.2555555555556; 6.4111111111111, 5.6111111111111; 6.3555555555556, 6.0444444444444; 6.1888888888889, 6.4111111111111; 5.7222222222222, 6.7; 5.2666666666667, 6.8777777777778; 4.8666666666667, 6.9111111111111; 4.4888888888889, 6.8666666666667; 4.1222222222222, 6.6555555555556; 3.9, 6.4222222222222; 3.5555555555556, 6.1444444444444; 3.3222222222222, 5.8333333333333; 3.0666666666667, 5.5888888888889; 2.6888888888889, 5.5111111111111; 2.8, 5.9; 3.2111111111111, 6.3; 3.5444444444444, 6.5444444444444; 3.1222222222222, 6.5; 2.7333333333333, 6.3888888888889; 2.5555555555556, 6.2111111111111; 2.2111111111111, 5.9222222222222; 1.9666666666667, 5.5444444444444; 1.7777777777778, 5.1111111111111; 1.6888888888889, 4.8555555555556; 1.6, 4.5333333333333; 1.6777777777778, 4.1333333333333; 1.2222222222222, 4.1888888888889; 1.0111111111111, 4.5777777777778; 1, 5; 0.8333333333333, 5.5333333333333; 1, 6; 1.1333333333333, 6.6444444444444; 1.7, 7.2666666666667; 2.1333333333333, 7.6444444444444; 2.5666666666667, 8.0333333333333; 2.9888888888889, 8.2777777777778; 3.6333333333333, 8.3333333333333; 4.2333333333333, 8.3777777777778; 4.7, 8.4; 5.2444444444444, 8.3333333333333; 5.6222222222222, 8.1666666666667; 6.1111111111111, 7.8555555555556; 6.4222222222222, 7.6333333333333; 6.7555555555556, 7.4888888888889; 7.1222222222222, 7.2; 6.8111111111111, 6.7777777777778; 7.0666666666667, 6.5111111111111; 7.2777777777778, 6.3666666666667; 7.4222222222222, 6.0555555555556; 7.4333333333333, 5.6444444444444; 7.2111111111111, 5.1666666666667; 7.1666666666667, 4.8888888888889; 7.1222222222222, 4.6888888888889]

% Create visualizer
viz = Visualizer2D;
viz.hasWaypoints = true;

%% Pure Pursuit Controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
controller.LookaheadDistance = 0.15;
controller.DesiredLinearVelocity = 0.35;
controller.MaxAngularVelocity = 2.2;

%% Simulation loop
close all
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec) 
    % Run the Pure Pursuit controller and convert output to wheel speeds
    [vRef,wRef] = controller(pose(:,idx-1));
    [wL,wR] = inverseKinematics(dd,vRef,wRef);
    
    % Compute the velocities
    [v,w] = forwardKinematics(dd,wL,wR);
    velB = [v;0;w]; % Body velocities [vx;vy;w]
    vel = bodyToWorld(velB,pose(:,idx-1));  % Convert from body to world
    
    % Perform forward discrete integration step
    pose(:,idx) = pose(:,idx-1) + vel*sampleTime; 
    
    % Update visualization
    viz(pose(:,idx),waypoints)
    waitfor(r);
end